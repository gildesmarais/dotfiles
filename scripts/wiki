#!/usr/bin/env bash
#
# wiki
#
# An interactive search interface for a local wiki. Uses `fzf` for the UI,
# `ripgrep` for content searching, `bat` for previews, and opens the selected
# file in VS Code. Combines several best-in-class CLI tools into a single,
# cohesive workflow.

# A local wiki search tool using fzf, ripgrep, bat, and VS Code.
# Editor is fixed to 'code' but you may set $EDITOR or $VISUAL for other scripts.

set -euo pipefail

wiki_path="$HOME/versioned/gildesmarais/wiki"
initial_query="${1:-}"

if [[ "$initial_query" == "--help" ]]; then
  cat <<EOF
Usage: wiki [search_query | --help]

Search and open wiki content from: $wiki_path

Modes:
  --help              Show this help message.

Keys:
  Ctrl-F              Switch to file name search
  Ctrl-G              Return to content search

Dependencies:
  - fzf
  - ripgrep (rg)
  - bat (for previews)
  - code (Visual Studio Code CLI)

Examples:
  wiki                # Start browsing all wiki content
  wiki "topic"        # Search for "topic"
EOF
  exit 0
fi

cd "$wiki_path" || {
  echo "Error: Cannot enter wiki directory: $wiki_path"
  exit 1
}

editor="code"
cmd_file="find . -type f"
cmd_rg="rg --color=always --line-number --no-heading --with-filename --smart-case"

# Define a function for the fzf preview.
# We export it so it's available to the subshell that fzf creates.
_fzf_preview_func() {
  if [[ "$1" == *:* ]]; then
    local file="${1%%:*}"
    local line="${1#*:}"
    line="${line%%:*}"
    bat --color=always --highlight-line "$line" --line-range=:500 "${file#./}"
  else
    bat --color=always --style=numbers --line-range=:500 "${1#./}"
  fi
}
export -f _fzf_preview_func

# Set the preview command to call our exported function.
preview_cmd='_fzf_preview_func {}'

fzf_opts=(
  --ansi
  --layout=reverse
  --border
  --height=40%
  --info=inline
  --exit-0
  --preview "$preview_cmd"
  --preview-window 'right:50%'
  --bind "ctrl-f:reload($cmd_file)"
  --bind "ctrl-g:reload($cmd_rg {q})"
  --query "$initial_query"
)

if [[ -n "$initial_query" ]]; then
  echo "Searching content for '$initial_query'..."
else
  echo "Starting interactive wiki search (Ctrl-F = file name, Ctrl-G = content)..."
fi

fzf_selection="$(
  rg --color=always --line-number --no-heading --with-filename --smart-case "" |
  fzf "${fzf_opts[@]}"
)"

if [[ -n "$fzf_selection" ]]; then
  file="${fzf_selection%%:*}"
  line_and_rest="${fzf_selection#*:}"
  line="${line_and_rest%%:*}"
  file="${file#./}"

  if [[ "$fzf_selection" == *:*:* ]]; then
    echo "Opening $file at line $line in VS Code"
    "$editor" . --goto "$file:$line"
  else
    echo "Opening $file in VS Code"
    "$editor" . "$file"
  fi
else
  echo "No selection made. Opening wiki root in VS Code."
  "$editor" .
fi
