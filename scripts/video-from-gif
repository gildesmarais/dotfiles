#!/usr/bin/env bash
#
# gif2mp4
#
# Converts a GIF to a high-quality, web-optimized MP4 using a two-pass
# ffmpeg encoding process. This provides better compression and ensures video
# dimensions are even, making it ideal for web use.

set -euo pipefail

# Input GIF file
INPUT_FILE="$1"
# Output MP4 file name
OUTPUT_FILE="$(basename -s '.gif' "$INPUT_FILE").mp4"

# Improved quality settings
BITRATE="1M"  # Target bitrate for better quality
PRESET="slow"  # Slower preset for better compression

# Check if the output file already exists
if [[ -f "$OUTPUT_FILE" ]]; then
  echo "Output file $OUTPUT_FILE already exists. Skipping conversion."
  exit 0
fi

# First pass
ffmpeg -y -i "$INPUT_FILE" \
  -vf "scale=trunc(iw/2)*2:trunc(ih/2)*2" \
  -c:v libx264 \
  -b:v "$BITRATE" \
  -preset "$PRESET" \
  -pass 1 \
  -an \
  -f mp4 /dev/null

# Second pass
ffmpeg -i "$INPUT_FILE" \
  -vf "scale=trunc(iw/2)*2:trunc(ih/2)*2" \
  -c:v libx264 \
  -b:v "$BITRATE" \
  -preset "$PRESET" \
  -pass 2 \
  -movflags +faststart \
  -pix_fmt yuv420p \
  "$OUTPUT_FILE"

# Clean up pass log files generated by ffmpeg
rm -f ffmpeg2pass-0.log ffmpeg2pass-0.log.mbtree
