#!/bin/bash
set -euo pipefail

# Main entry point for the modular todo script.
SOURCE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# shellcheck disable=SC1091
. "$SOURCE_DIR/state.sh"
# shellcheck disable=SC1091
. "$SOURCE_DIR/dispatch.sh"
# shellcheck disable=SC1091
. "$SOURCE_DIR/lib/note_utils.sh"
# shellcheck disable=SC1091
. "$SOURCE_DIR/ui/renderer.sh"

for cmd_file in "$SOURCE_DIR"/cmd/*.sh; do
    # shellcheck source=/dev/null
    . "$cmd_file"
done

_config
_init_state
_check_dependencies

COMMAND=""
TODO_ITEMS=()

while getopts ":v" opt; do
    case ${opt} in
        v)
            export VERBOSE_FLAG="true"
            ;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            show_help
            exit 1
            ;;
    esac
done
shift $((OPTIND - 1))

if [ $# -gt 0 ]; then
    COMMAND="$1"
    shift
fi

if [ $# -gt 0 ]; then
    TODO_ITEMS+=("$@")
fi

if [ -p /dev/stdin ]; then
    while IFS= read -r line; do
        if [ -n "$line" ]; then
            TODO_ITEMS+=("$line")
        fi
    done
fi

if [ -z "$COMMAND" ]; then
    if [ ${#TODO_ITEMS[@]} -gt 0 ]; then
        COMMAND="add"
    else
        show_help
        exit_gracefully
    fi
fi

dispatch "$COMMAND" "$@"

exit_gracefully
